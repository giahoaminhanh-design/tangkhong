// logic giữ nguyên từ v7